function z(e){const o=`; ${document.cookie}`.split(`; ${e}=`);return o.length===2?o.pop().split(";").shift():null}function O(e,t,o){let n="";{const s=new Date;s.setTime(s.getTime()+o*24*60*60*1e3),n="; expires="+s.toUTCString()}document.cookie=e+"="+(t||"")+n+"; path=/; SameSite=Lax"}function d(e){return typeof e!="string"?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function U(e){return typeof e>"u"||e===null?"":(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br>$2")}const j=e=>{const t=document.documentElement;if(!t)return;e==="dark"?t.classList.add("dark"):t.classList.remove("dark");const o=document.getElementById("theme-toggle-sun-icon"),n=document.getElementById("theme-toggle-moon-icon");o&&n&&(o.style.display=e==="dark"?"none":"block",n.style.display=e==="dark"?"block":"none");const s=document.getElementById("theme-toggle-sun-icon-logged-out"),i=document.getElementById("theme-toggle-moon-icon-logged-out");s&&i&&(s.style.display=e==="dark"?"none":"block",i.style.display=e==="dark"?"block":"none")},L=()=>{const t=(document.documentElement.classList.contains("dark")?"dark":"light")==="dark"?"light":"dark";O("ui-theme",t,365),j(t)},J=()=>{console.log("Attempting to initialize theme...");const e=z("ui-theme"),t=e==="dark"||e==="light"?e:"light";(!e||e!=="dark"&&e!=="light")&&O("ui-theme",t,365),j(t);const o=document.getElementById("theme-toggle"),n=document.getElementById("theme-toggle-logged-out");o&&(o.removeEventListener("click",L),o.addEventListener("click",L)),n&&(n.removeEventListener("click",L),n.addEventListener("click",L)),console.log("Theme initialized to:",t)},F=(e,t,o)=>{var r;const n=e.querySelector(".like-count"),s=(r=e.querySelector("svg"))==null?void 0:r.parentElement;if(!n||!s){console.error("Could not find like count span or icon container for button:",e);return}n.textContent=o,e.classList.toggle("text-red-500",t),e.classList.toggle("font-medium",t),e.classList.toggle("text-muted-foreground",!t);const i=e.querySelector(".like-icon-filled"),c=e.querySelector(".like-icon-outline");i&&c?(i.style.display=t?"block":"none",c.style.display=t?"none":"block"):console.warn("Could not find like icons within button:",e),e.setAttribute("aria-pressed",t.toString())},w=async e=>{const t=e.currentTarget,o=t.dataset.postId;if(!o||t.disabled)return;const s=t.getAttribute("aria-pressed")==="true"?"DELETE":"POST",i=`/api/posts/${o}/like`;t.disabled=!0,t.classList.add("opacity-70");try{const c=await fetch(i,{method:s,headers:{Accept:"application/json"}}),r=await c.json();!c.ok||!r.success?console.error(`Failed to ${s==="POST"?"like":"unlike"} post:`,r.message||`HTTP ${c.status}`):(F(t,r.userLiked,r.newLikeCount),t.setAttribute("aria-label",r.userLiked?"Unlike post":"Like post"))}catch(c){console.error("Network error during like/unlike:",c)}finally{t.disabled=!1,t.classList.remove("opacity-70")}},R=()=>{console.log("Attempting to initialize like buttons...");const e=document.querySelectorAll(".like-button");e.forEach(t=>{const o=t.classList.contains("text-red-500");t.setAttribute("aria-pressed",o.toString()),t.setAttribute("aria-label",o?"Unlike post":"Like post"),t.disabled||(t.removeEventListener("click",w),t.addEventListener("click",w))}),console.log(`Initialized ${e.length} like buttons.`)},_=e=>{const t=document.createElement("div");t.classList.add("comment-item","flex","items-start","space-x-2"),t.dataset.commentId=e.comment_id;const o=e.author_picture_url||"https://via.placeholder.com/32/cccccc/969696?text=",n=e.author_name||"Unknown User",s=e.time_ago||"",i=e.content||"";return t.innerHTML=` <img src="${d(o)}" alt="${d(n)}'s profile picture" class="w-8 h-8 rounded-full border bg-muted flex-shrink-0"> <div class="flex-grow bg-muted/50 dark:bg-muted/20 rounded-md px-3 py-1.5"> <div class="flex items-baseline space-x-2"> <span class="font-semibold text-foreground text-xs">${d(n)}</span> <span class="text-muted-foreground text-xs">${d(s)}</span> </div> <p class="text-foreground leading-snug">${d(i).replace(/\n/g,"<br>")}</p> </div> `,t},X=async(e,t)=>{const o=t.querySelector(".comment-list"),n=t.querySelector(".loading-comments");if(!(!o||!n)){n.style.display="block",o.innerHTML="",o.appendChild(n);try{const s=await fetch(`/api/posts/${e}/comments`),i=await s.json();n.style.display="none",!s.ok||!i.success?(console.error("Failed to load comments:",i.message||`HTTP ${s.status}`),o.innerHTML='<p class="text-destructive text-xs">Could not load comments.</p>'):i.comments&&i.comments.length>0?i.comments.forEach(c=>{o.appendChild(_(c))}):o.innerHTML='<p class="text-muted-foreground text-xs no-comments">No comments yet.</p>'}catch(s){console.error("Network error loading comments:",s),n.style.display="none",o.innerHTML='<p class="text-destructive text-xs">Error loading comments.</p>'}}},$=e=>{var c;const t=e.currentTarget,o=t.dataset.postId,n=`comment-section-${o}`,s=document.getElementById(n);if(!s)return;if(t.getAttribute("aria-expanded")==="true")s.classList.add("hidden"),t.setAttribute("aria-expanded","false");else{s.classList.remove("hidden"),t.setAttribute("aria-expanded","true");const r=((c=s.querySelector(".comment-list"))==null?void 0:c.innerHTML.trim())||"";(!!s.querySelector(".loading-comments")||r===""||r.includes("no-comments")||r.includes("Could not load"))&&X(o,s)}},I=async e=>{e.preventDefault();const t=e.currentTarget,o=t.dataset.postId,n=t.querySelector('textarea[name="content"]'),s=t.querySelector('button[type="submit"]'),i=document.getElementById(`comment-section-${o}`),c=i?i.querySelector(".comment-list"):null,r=document.querySelector(`[data-post-container-id="${o}"]`),a=r?r.querySelector(".comment-count-display"):null;if(console.log("handleAddComment Debug Info:"),console.log("  - Post ID:",o),console.log("  - Textarea found:",!!n),console.log("  - Submit Button found:",!!s),console.log("  - Comment Section found:",!!i),console.log("  - Comment List found:",!!c),console.log("  - Post Container found:",!!r),console.log("  - Comment Count Display found:",!!a),!o||!n||!s||!c||!a||!i||!r){console.error("Could not find necessary elements for adding comment. Check specific logs above.");return}const g=c,u=a,m=n.value.trim();if(m===""){n.focus(),n.classList.add("ring-1","ring-destructive"),setTimeout(()=>n.classList.remove("ring-1","ring-destructive"),1500);return}s.disabled=!0,s.textContent="Posting...";const S={content:m};console.log("[Comment Store - JS Sending]",JSON.stringify(S));try{const k=await fetch(`/api/posts/${o}/comments`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(S)}),f=await k.json();if(!k.ok||!f.success)console.error("Failed to add comment:",f.message||`HTTP ${k.status}`),alert(`Error: ${f.message||"Could not post comment."}`);else{n.value="";const T=g.querySelector(".no-comments");T&&T.remove(),f.comment&&g.appendChild(_(f.comment));const C=f.newCommentCount;u.textContent=`${C} ${C===1?"Comment":"Comments"}`}}catch(k){console.error("Network error adding comment:",k),alert("A network error occurred. Please try again.")}finally{s.disabled=!1,s.textContent="Post"}},G=()=>{console.log("Attempting to initialize comments..."),document.querySelectorAll(".comment-toggle-button").forEach(e=>{e.removeEventListener("click",$),e.disabled||e.addEventListener("click",$)}),document.querySelectorAll(".add-comment-form").forEach(e=>{e.removeEventListener("submit",I),e.addEventListener("submit",I)}),console.log("Comment listeners attached.")},K=(e,t)=>{const o=e.querySelector(".follow-text");o&&(o.textContent=t?"Following":"Follow",e.classList.toggle("border",t),e.classList.toggle("border-input",t),e.classList.toggle("bg-background",t),e.classList.toggle("hover:bg-accent",t),e.classList.toggle("hover:text-accent-foreground",t),e.classList.toggle("bg-primary",!t),e.classList.toggle("text-primary-foreground",!t),e.classList.toggle("hover:bg-primary/90",!t),e.setAttribute("aria-pressed",t.toString()))},q=async e=>{const t=e.currentTarget,o=t.dataset.userId,n=t.querySelector(".loading-spinner");if(!o||t.disabled)return;const i=t.getAttribute("aria-pressed")==="true"?"DELETE":"POST",c=`/api/users/${o}/follow`;t.disabled=!0,n&&n.classList.remove("hidden");try{const r=await fetch(c,{method:i,headers:{Accept:"application/json"}}),a=await r.json();!r.ok||!a.success?(console.error(`Failed to ${i==="POST"?"follow":"unfollow"} user:`,a.message||`HTTP ${r.status}`),alert(`Error: ${a.message||"Could not perform follow action."}`)):(K(t,a.isFollowingNow),console.log(a.message))}catch(r){console.error("Network error during follow/unfollow:",r),alert("A network error occurred. Please try again.")}finally{t.disabled=!1,n&&n.classList.add("hidden")}},Q=()=>{console.log("Attempting to initialize follow buttons..."),document.querySelectorAll(".follow-toggle-button").forEach(e=>{e.removeEventListener("click",q),e.disabled||e.addEventListener("click",q)}),console.log("Follow button listeners attached.")},E=(e,t)=>{var c;const o=e.querySelector(".post-display-content"),n=e.querySelector(".post-edit-form"),s=e.querySelector(".post-options-menu"),i=n==null?void 0:n.querySelector(".edit-status");if(!(!o||!n))if(o.classList.toggle("hidden",t),n.classList.toggle("hidden",!t),i&&(i.textContent=""),t&&s&&s.classList.add("hidden"),t)(c=n.querySelector("textarea"))==null||c.focus();else{o.innerHTML;const r=o.textContent||"";n.querySelector("textarea").value=r}},A=e=>{const o=e.currentTarget.closest("article[data-post-container-id]");o&&E(o,!0)},B=e=>{const o=e.currentTarget.closest("article[data-post-container-id]");o&&E(o,!1)},N=async e=>{e.preventDefault();const t=e.currentTarget,o=t.dataset.postId,n=t.querySelector('textarea[name="content"]'),s=t.querySelector(".edit-save-button"),i=t.querySelector(".edit-cancel-button"),c=t.querySelector(".edit-status"),r=t.closest("article[data-post-container-id]"),a=r==null?void 0:r.querySelector(".post-display-content");if(!o||!n||!s||!i||!r||!a||!c){console.error("Missing elements for edit save.");return}const g=n.value.trim();if(g===""){alert("Post content cannot be empty."),n.focus();return}s.disabled=!0,i.disabled=!0,n.disabled=!0,c.textContent="Saving...",c.classList.remove("text-destructive");try{const u=await fetch(`/api/posts/${o}/update`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({content:g})}),m=await u.json();!u.ok||!m.success?(console.error("Failed to update post:",m.message||`HTTP ${u.status}`),c.textContent=`Error: ${m.message||"Could not save."}`,c.classList.add("text-destructive"),s.disabled=!1,i.disabled=!1,n.disabled=!1):(a.innerHTML=m.newContentHtml||U(d(g)),c.textContent="",E(r,!1),s.disabled=!1,i.disabled=!1,n.disabled=!1)}catch(u){console.error("Network error updating post:",u),c.textContent="Network error.",c.classList.add("text-destructive"),s.disabled=!1,i.disabled=!1,n.disabled=!1}},P=async e=>{const t=e.currentTarget,o=t.closest("article[data-post-container-id]"),n=o==null?void 0:o.dataset.postContainerId,s=t.closest(".post-options-menu");if(!(!n||!o)){if(!confirm("Are you sure you want to delete this post? This cannot be undone.")){s&&s.classList.add("hidden");return}t.disabled=!0,s&&s.classList.add("hidden");try{const i=await fetch(`/api/posts/${n}`,{method:"DELETE",headers:{Accept:"application/json"}}),c=await i.json();!i.ok||!c.success?(console.error("Failed to delete post:",c.message||`HTTP ${i.status}`),alert(`Error: ${c.message||"Could not delete post."}`),t.disabled=!1):(console.log(c.message),o.style.transition="opacity 0.5s ease-out",o.style.opacity="0",setTimeout(()=>{o.remove()},500))}catch(i){console.error("Network error deleting post:",i),alert("A network error occurred while deleting the post."),t.disabled=!1}}},V=()=>{console.log("Attempting to initialize post options..."),document.querySelectorAll(".post-options-dropdown").forEach(e=>{const t=e.querySelector(".post-options-button"),o=e.querySelector(".post-options-menu");if(!t||!o)return;t.removeEventListener("click",H),t.addEventListener("click",H);const n=o.querySelector(".post-edit-button");n&&(n.removeEventListener("click",A),n.addEventListener("click",A));const s=o.querySelector(".post-delete-button");s&&(s.removeEventListener("click",P),s.addEventListener("click",P))}),document.removeEventListener("click",b),document.addEventListener("click",b),document.querySelectorAll(".post-edit-form").forEach(e=>{const t=e.querySelector(".edit-cancel-button");t&&(t.removeEventListener("click",B),t.addEventListener("click",B)),e.removeEventListener("submit",N),e.addEventListener("submit",N)}),console.log("Post options listeners attached.")},H=e=>{var s;e.stopPropagation();const o=(s=e.currentTarget.closest(".post-options-dropdown"))==null?void 0:s.querySelector(".post-options-menu");if(!o)return;const n=o.classList.contains("hidden");b(e,o),n?o.classList.remove("hidden"):o.classList.add("hidden")},b=(e,t=null)=>{document.querySelectorAll(".post-options-menu").forEach(o=>{o!==t&&!o.closest(".post-options-dropdown").contains(e.target)&&o.classList.add("hidden")})},x=document.getElementById("notification-toggle-button"),y=document.getElementById("notification-count-badge"),v=document.getElementById("notification-list"),p=document.getElementById("notification-items-container"),h=document.getElementById("mark-all-read-button");let l=[];const W=e=>{let t="",o="#";const n=d(e.actor_name||"Someone"),s=d(e.actor_picture||"https://via.placeholder.com/32/cccccc/969696?text="),i=d(e.time_ago||"");switch(e.type){case"like":t="liked your post.",e.post_id&&(o=`/post/${e.post_id}`,o="#");break;case"comment":t="commented on your post.",e.post_id&&(o=`/post/${e.post_id}`,o="#");break;case"follow":t="started following you.",e.actor_id&&(o=`/profile/${e.actor_id}`);break;default:t="sent you a notification."}return`
                    <a href="${o}" class="notification-item flex items-start px-3 py-2 hover:bg-accent text-foreground" data-notification-id="${e.id}">
                        <img src="${s}" alt="${n}'s picture" class="w-8 h-8 rounded-full border bg-muted mr-2 flex-shrink-0">
                        <div class="flex-grow">
                            <p class="text-xs leading-snug">
                                <strong class="font-medium">${n}</strong> ${t}
                            </p>
                            <p class="text-xs text-muted-foreground mt-0.5">${i}</p>
                        </div>
                        ${e.is_read?"":'<span class="ml-2 mt-1 w-2 h-2 bg-primary rounded-full flex-shrink-0" title="Unread"></span>'}
                    </a>
                `},D=(e,t)=>{y&&(e>0?(y.textContent=e>9?"9+":e,y.classList.remove("hidden")):y.classList.add("hidden")),p&&(t.length>0?p.innerHTML=t.map(W).join(""):p.innerHTML='<p class="p-4 text-muted-foreground text-center text-xs">No unread notifications.</p>'),h&&(h.disabled=e===0)},Y=async()=>{if(x){console.log("Fetching notifications...");try{const e=await fetch("/api/notifications");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();t.success?(l=t.notifications||[],D(t.unread_count||0,l)):(console.error("Failed to fetch notifications:",t.message),p&&(p.innerHTML='<p class="p-4 text-destructive text-center text-xs">Could not load notifications.</p>'))}catch(e){console.error("Network error fetching notifications:",e),p&&(p.innerHTML='<p class="p-4 text-destructive text-center text-xs">Error loading notifications.</p>'),y&&y.classList.add("hidden"),h&&(h.disabled=!0)}}},M=async(e=null)=>{if(!e&&l.length===0)return;const t=e||l.map(o=>o.id);if(t.length!==0){console.log("Marking notifications read:",t);try{const o=await fetch("/api/notifications/mark-read",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({ids:t})}),n=await o.json();!o.ok||!n.success?console.error("Failed to mark notifications read:",n.message):(console.log("Notifications marked read."),l=l.filter(s=>!t.includes(s.id)),D(l.length,l))}catch(o){console.error("Network error marking notifications read:",o)}}},Z=()=>{x&&(console.log("Initializing notifications..."),x.addEventListener("click",e=>{e.stopPropagation();const t=v.classList.contains("hidden");b(e),v.classList.toggle("hidden"),t&&l.length>0&&setTimeout(()=>{M()},1500)}),h&&h.addEventListener("click",()=>{M()}),document.addEventListener("click",e=>{!v.classList.contains("hidden")&&!notificationDropdownContainer.contains(e.target)&&v.classList.add("hidden")}),Y(),console.log("Notification listeners attached."))};document.addEventListener("DOMContentLoaded",()=>{console.log("DOMContentLoaded event fired."),J(),R(),G(),Q(),V(),Z()});console.log("Bailanysta app.js script parsed (Includes Notification AJAX).");
